# PostgreSQL Multi-Master HA Cluster with HAProxy

This project provisions a highly available PostgreSQL 17 multi-master cluster on AWS using Terraform and Ansible.

## Architecture

```
                    ┌─────────────────┐
                    │    HAProxy      │
                    │   (Load Balancer)│
                    │   Port: 5000    │
                    └────────┬────────┘
                             │
           ┌─────────────────┼─────────────────┐
           │                 │                 │
           ▼                 ▼                 ▼
    ┌──────────┐      ┌──────────┐      ┌──────────┐
    │ pg-node-1│◄────►│ pg-node-2│◄────►│ pg-node-3│
    │  (PG 17) │      │  (PG 17) │      │  (PG 17) │
    │ pglogical│      │ pglogical│      │ pglogical│
    │  RepMgr  │      │  RepMgr  │      │  RepMgr  │
    └──────────┘      └──────────┘      └──────────┘
         ▲                 ▲                 ▲
         └─────────────────┴─────────────────┘
              Bidirectional Replication
```

## Components

- **PostgreSQL 17**: Latest major version with advanced features
- **pglogical 2**: Logical replication extension enabling multi-master setup
- **RepMgr**: Cluster monitoring and management tool
- **HAProxy**: TCP load balancer for distributing connections

## Important Notes

### About Multi-Master Replication

This setup uses **pglogical** for bidirectional (multi-master) replication. Key considerations:

1. **Conflict Resolution**: Configured with "last_update_wins" strategy
2. **Primary Keys Required**: All replicated tables MUST have primary keys
3. **DDL Not Replicated**: Schema changes must be applied to all nodes manually
4. **Sequence Management**: Consider using different ranges per node to avoid conflicts

### About RepMgr

RepMgr is traditionally designed for streaming replication (single-master with standbys). In this multi-master setup, it's configured for:
- Cluster monitoring
- Node health checking
- Administrative operations

## Prerequisites

- AWS Account with appropriate permissions
- Terraform >= 1.5.0
- Ansible >= 2.14
- Python 3.8+
- AWS CLI configured

## Quick Start

### 1. Clone and Configure

```bash
cd postgres-ha-cluster/terraform

# Copy and customize variables
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your settings
```

### 2. Deploy Infrastructure

```bash
# Initialize Terraform
terraform init

# Review the plan
terraform plan

# Apply (creates 4 EC2 instances)
terraform apply
```

### 3. Configure the Cluster

```bash
cd ../ansible

# Install Ansible Galaxy requirements
ansible-galaxy install -r requirements.yml

# Run the playbook
ansible-playbook -i inventory/hosts.yml site.yml
```

## Directory Structure

```
postgres-ha-cluster/
├── terraform/
│   ├── main.tf                 # Main configuration, providers, SSH key
│   ├── variables.tf            # Variable definitions
│   ├── outputs.tf              # Output values
│   ├── vpc.tf                  # VPC and networking
│   ├── security_groups.tf      # Security group rules
│   ├── instances.tf            # EC2 instances
│   ├── terraform.tfvars.example
│   └── templates/
│       └── inventory.yml.tpl   # Ansible inventory template
│
├── ansible/
│   ├── ansible.cfg             # Ansible configuration
│   ├── site.yml                # Main playbook
│   ├── requirements.yml        # Galaxy requirements
│   ├── inventory/
│   │   └── hosts.yml           # Generated by Terraform
│   ├── group_vars/
│   │   └── all.yml             # Global variables
│   └── roles/
│       ├── common/             # Base system setup
│       ├── postgresql/         # PostgreSQL installation
│       ├── repmgr/             # RepMgr installation
│       ├── pglogical/          # pglogical provider setup
│       ├── pglogical_subscriptions/  # Multi-master subscriptions
│       └── haproxy/            # HAProxy load balancer
│
└── README.md
```

## Connection Information

After deployment:

```bash
# Get connection details
cd terraform
terraform output

# Connect via HAProxy (load balanced)
psql -h <haproxy_public_ip> -p 5000 -U appuser -d appdb

# Connect directly to a node
psql -h <pg_node_ip> -p 5432 -U appuser -d appdb

# HAProxy Statistics
http://<haproxy_public_ip>:7000/stats
# Default credentials: admin / HAProxy!Stats
```

## HAProxy Endpoints

| Port | Purpose | Balance Method |
|------|---------|----------------|
| 5000 | Main PostgreSQL (read/write) | Round Robin |
| 5001 | Read-only connections | Least Connections |
| 5002 | Sticky sessions | Source IP affinity |
| 7000 | Statistics dashboard | N/A |

## Security Considerations

**Before Production:**

1. **Restrict CIDR blocks** in `terraform.tfvars`:
   ```hcl
   allowed_ssh_cidrs      = ["YOUR_OFFICE_IP/32"]
   allowed_postgres_cidrs = ["YOUR_APP_SUBNET/24"]
   ```

2. **Use Ansible Vault** for sensitive data:
   ```bash
   ansible-vault encrypt_string 'YourSecurePassword' --name 'vault_replication_password'
   ```

3. **Enable SSL/TLS** for PostgreSQL connections

4. **Move instances to private subnets** in production

5. **Use AWS Secrets Manager** for credential management

## Validation Commands

```bash
# Check cluster status from any PostgreSQL node
sudo -u postgres repmgr cluster show

# Check pglogical node status
sudo -u postgres psql -d appdb -c "SELECT * FROM pglogical.node;"

# Check subscription status
sudo -u postgres psql -d appdb -c "SELECT * FROM pglogical.subscription;"

# Check replication lag
sudo -u postgres psql -d appdb -c "SELECT * FROM pglogical.local_sync_status;"

# Test multi-master write
# On node 1:
sudo -u postgres psql -d appdb -c "INSERT INTO sample_data (data) VALUES ('from node 1');"

# On node 2 (should appear):
sudo -u postgres psql -d appdb -c "SELECT * FROM sample_data;"
```

## Troubleshooting

### Replication Issues

```bash
# Check pglogical logs
sudo journalctl -u postgresql -f

# Check subscription status
sudo -u postgres psql -d appdb -c "
  SELECT sub_name, sub_status, sub_enabled 
  FROM pglogical.subscription;
"

# Resync a subscription
sudo -u postgres psql -d appdb -c "
  SELECT pglogical.alter_subscription_resynchronize_table(
    'subscription_name', 'table_name'
  );
"
```

### HAProxy Issues

```bash
# Check HAProxy status
sudo systemctl status haproxy

# Validate configuration
sudo haproxy -c -f /etc/haproxy/haproxy.cfg

# Check backend health
curl -u admin:HAProxy!Stats http://localhost:7000/stats
```

## Cleanup

```bash
cd terraform
terraform destroy
```

## Limitations

1. **DDL Replication**: Schema changes are NOT automatically replicated
2. **Large Objects**: LOBs are not supported by pglogical
3. **Sequences**: Must be managed carefully to avoid conflicts
4. **Truncate**: TRUNCATE is replicated but requires superuser

## Cost Estimate (AWS us-east-1)

| Resource | Quantity | Estimated Monthly Cost |
|----------|----------|----------------------|
| t3.medium (PostgreSQL) | 3 | ~$90 |
| t3.small (HAProxy) | 1 | ~$15 |
| EBS gp3 (100GB each) | 3 | ~$24 |
| NAT Gateway | 1 | ~$45 |
| Data Transfer | Variable | ~$10-50 |
| **Total** | | **~$185-220/month** |

## License

MIT License - See LICENSE file for details.

## Contributing

1. Fork the repository
2. Create a feature branch
3. Submit a pull request

## Support

For issues and questions, please open a GitHub issue.
